model patch_rating {
  id Int @id @default(autoincrement())

  // strong_no, no, neutral, yes, strong_yes
  recommend     String
  // 1-10
  overall       Int
  // not_started, in_progress, finished_one, finished_main, finished_all, dropped
  play_status   String @default("not_started")
  short_summary String @default("") @db.VarChar(1314)
  // summary spoiler - none, portion, serious
  spoiler_level String @default("none")

  user_id  Int
  user     user  @relation(fields: [user_id], references: [id])
  patch_id Int
  patch    patch @relation(fields: [patch_id], references: [id])

  like patch_rating_like[]

  created DateTime @default(now())
  updated DateTime @updatedAt

  // user can rating a patch only once
  @@unique([user_id, patch_id])
  @@index([patch_id])
}

model patch_rating_like {
  id Int @id @default(autoincrement())

  patch_rating_id Int
  patch_rating    patch_rating @relation(fields: [patch_rating_id], references: [id], onDelete: Cascade)
  user_id         Int
  user            user         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@unique([patch_rating_id, user_id])
}

/// Aggregated statistics for patch ratings to speed up reads and sorting
model patch_rating_stat {
  // Primary key also references patch
  patch_id Int   @id
  patch    patch @relation(fields: [patch_id], references: [id], onDelete: Cascade)

  // Average overall (1-10), one decimal is enough but use Float
  avg_overall Float @default(0)
  count       Int   @default(0)

  // Recommend counters
  rec_strong_no  Int @default(0)
  rec_no         Int @default(0)
  rec_neutral    Int @default(0)
  rec_yes        Int @default(0)
  rec_strong_yes Int @default(0)

  // Overall score histogram 1..10
  o1  Int @default(0)
  o2  Int @default(0)
  o3  Int @default(0)
  o4  Int @default(0)
  o5  Int @default(0)
  o6  Int @default(0)
  o7  Int @default(0)
  o8  Int @default(0)
  o9  Int @default(0)
  o10 Int @default(0)

  created DateTime @default(now())
  updated DateTime @updatedAt

  @@index([avg_overall])
  @@index([count])
}
